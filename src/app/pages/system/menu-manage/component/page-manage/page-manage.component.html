<div class="page-manage-flex">
  <!-- SEO 設定側邊欄 -->
  <aside class="seo-sidebar">
    <h3>SEO 設定</h3>
    <form [formGroup]="seoForm">
      SEO 標題
      <mat-form-field appearance="outline">
        <input matInput formControlName="title" maxlength="60" />
        <mat-hint align="end">{{seoForm.get('title')?.value?.length || 0}}/60</mat-hint>
        <mat-error *ngIf="seoForm.get('title')?.hasError('required')">
          標題為必填欄位
        </mat-error>
        <mat-error *ngIf="seoForm.get('title')?.hasError('maxlength')">
          標題不可超過 60 個字元
        </mat-error>
      </mat-form-field>
      SEO 描述
      <mat-form-field appearance="outline">
        <input matInput formControlName="description" maxlength="160">
        <mat-hint align="end">{{seoForm.get('description')?.value?.length || 0}}/160</mat-hint>
        <mat-error *ngIf="seoForm.get('description')?.hasError('required')">
          描述為必填欄位
        </mat-error>
        <mat-error *ngIf="seoForm.get('description')?.hasError('maxlength')">
          描述不可超過 160 個字元
        </mat-error>
      </mat-form-field>
      SEO 關鍵字
      <mat-form-field appearance="outline">
        <input matInput formControlName="keywords" placeholder="以逗號分隔" />
        <mat-error *ngIf="seoForm.get('keywords')?.hasError('required')">
          關鍵字為必填欄位
        </mat-error>
      </mat-form-field>
      OG 圖片
      <mat-form-field appearance="outline">
        <input matInput formControlName="ogImage" placeholder="圖片網址" />
      </mat-form-field>
      標籤名稱
      <mat-form-field appearance="outline">
        <input matInput formControlName="tagName" placeholder="以逗號分隔" />
      </mat-form-field>

      <!-- SEO 表單狀態顯示 -->
      <div class="form-status" *ngIf="seoForm.invalid && seoForm.touched">
        <mat-error>請修正上述錯誤後再儲存</mat-error>
      </div>

      <!-- 儲存按鈕 -->
      <button mat-raised-button color="primary"
              [disabled]="seoForm.invalid"
              (click)="saveSeoConfig()"
              style="margin-top: 16px;">
        <mat-icon>save</mat-icon>
        儲存 SEO 設定
      </button>
    </form>
  </aside>
  <div class="main-content">
    <div class="button-container fixed-button">
      <button mat-raised-button color="primary" (click)="addLayoutGroup()">
        <mat-icon>add</mat-icon>
        <span class="button-text">新增版型區塊</span>
      </button>
      <button mat-raised-button style="background-color: #00994e;color: #fff;" (click)="saveLayoutGroup()">
        <mat-icon>save</mat-icon>
        <span class="button-text">儲存</span>
      </button>
      <button mat-raised-button color="warn" (click)="deleteAllLayoutGroup()">
        <mat-icon>delete</mat-icon>
        <span class="button-text">清空所有區塊</span>
      </button>
    </div>
    <div class="layout-container">
      <div class="content-container" cdkDropList (cdkDropListDropped)="dropLayoutGroup($event)">
        <ng-container *ngIf="layoutGroups.length === 0">
          <div class="empty-state">尚未新增任何區塊</div>
        </ng-container>
        <ng-container *ngFor="let group of layoutGroups; let groupIndex = index">
          <ng-container [ngSwitch]="group.templateCode">
            <!-- 大圖輪播 -->
            <div *ngSwitchCase="'large_carousel'" class="block-carousel block-large" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <p-carousel [value]="group.data" [numVisible]="1" [numScroll]="1">
                  <ng-template let-item pTemplate="item">
                    <img [src]="item.imageUrl || '/assets/uploads/placeholder.png'" alt="" />
                  </ng-template>
                </p-carousel>
                <button mat-stroked-button color="primary" (click)="openImageManager(group)" class="add-image-btn">
                  <mat-icon>add_photo_alternate</mat-icon> 新增圖片
                </button>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            <!-- 小圖輪播 -->
            <div *ngSwitchCase="'small_carousel'" class="block-carousel block-small" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <p-carousel [value]="group.data" [numVisible]="3" [numScroll]="1">
                  <ng-template let-item pTemplate="item">
                    <img [src]="item.imageUrl || '/assets/uploads/placeholder.png'" alt="" />
                  </ng-template>
                </p-carousel>
                <button mat-stroked-button color="primary" (click)="addCarouselImage(group)" class="add-image-btn">
                  <mat-icon>add_photo_alternate</mat-icon> 新增圖片
                </button>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            <!-- 右圖左文 -->
            <div *ngSwitchCase="'RILT'" class="block-rilt" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <div class="block-content">
                  <p-editor [(ngModel)]="group.data[0].text" [modules]="editorOnlyText"
                    [style]="{ height: '200px' }"></p-editor>
                </div>
                <div class="block-img">
                  <img [src]="group.data[0].imageUrl || '/assets/uploads/placeholder.png'" alt="" />
                  <button mat-stroked-button color="primary" (click)="openImageManager(group.data[0])"
                    class="img-upload-btn">
                    <mat-icon>image</mat-icon> 選擇圖片
                  </button>
                </div>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            <!-- 左圖右文 -->
            <div *ngSwitchCase="'LIRT'" class="block-lirt" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <div class="block-img">
                  <img [src]="group.data[0].imageUrl || '/assets/uploads/placeholder.png'" alt="" />
                  <button mat-stroked-button color="primary" (click)="openImageManager(group.data[0])"
                    class="img-upload-btn">
                    <mat-icon>image</mat-icon> 選擇圖片
                  </button>
                </div>
                <div class="block-content">
                  <p-editor [(ngModel)]="group.data[0].text" [modules]="editorOnlyText"
                    [style]="{ height: '200px' }"></p-editor>
                </div>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            <!-- 上圖下文 -->
            <div *ngSwitchCase="'TIBT'" class="block-tibt" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <div class="block-img">
                  <img [src]="group.data[0].imageUrl || '/assets/uploads/placeholderLG.png'" alt="" />
                  <button mat-stroked-button color="primary" (click)="openImageManager(group.data[0])"
                    class="img-upload-btn">
                    <mat-icon>image</mat-icon> 選擇圖片
                  </button>
                </div>
                <div class="block-content">
                  <p-editor [(ngModel)]="group.data[0].text" [modules]="editorOnlyText"
                    [style]="{ height: '200px' }"></p-editor>
                </div>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <!-- 下圖上文 -->
            <div *ngSwitchCase="'BITT'" class="block-bitt" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <div class="block-content">
                  <p-editor [(ngModel)]="group.data[0].text" [modules]="editorOnlyText"
                    [style]="{ height: '200px' }"></p-editor>
                </div>
                <div class="block-img">
                  <img [src]="group.data[0].imageUrl || '/assets/uploads/placeholderLG.png'" alt="" />
                  <button mat-stroked-button color="primary" (click)="openImageManager(group.data[0])"
                    class="img-upload-btn">
                    <mat-icon>image</mat-icon> 選擇圖片
                  </button>
                </div>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <!-- 影片 -->
            <div *ngSwitchCase="'video'" class="block-video" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <div class="video-container">
                  <button mat-stroked-button color="primary" class="video-upload-btn">
                    <mat-icon>videocam</mat-icon> 上傳影片
                  </button>
                </div>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <!-- 純圖片 -->
            <div *ngSwitchCase="'image'" class="block-image" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <div class="block-img">
                  <img [src]="group.data[0].imageUrl || '/assets/uploads/placeholderLG.png'" alt="純圖片區塊" />
                  <button mat-stroked-button color="primary" (click)="openImageManager(group.data[0])"
                    class="img-upload-btn">
                    <mat-icon>image</mat-icon> 選擇圖片
                  </button>
                </div>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <!-- 純文字 -->
            <div *ngSwitchCase="'text'" class="block-text" cdkDrag>
              <div class="block-controls">
                <div class="drag-handle" cdkDragHandle>
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                <div class="sort-number">
                  <mat-form-field appearance="outline">
                    <mat-label>排序</mat-label>
                    <input matInput type="number" [(ngModel)]="group.sortOrder"
                      (blur)="updateSortByNumber(groupIndex, group.sortOrder)" min="1" [max]="layoutGroups.length">
                  </mat-form-field>
                </div>
              </div>
              <div class="block-main-content">
                <div class="text-content">
                  <p-editor [(ngModel)]="group.data[0].text" [modules]="editorModules"
                    [style]="{ height: '300px' }"></p-editor>
                </div>
              </div>
              <button mat-mini-fab color="warn" (click)="removeLayoutGroup(groupIndex)" class="block-remove-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>

          </ng-container>
        </ng-container>
      </div>
    </div>
  </div>
</div>
